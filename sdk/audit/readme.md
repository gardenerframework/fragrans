# 设计

这个模块负责接口的审计功能，审计是对系统开放的接口而言的，比如一个http服务会开放若干http接口。对于系统内部的类彼此之间的调用往往不需要进行审计。
在此，系统被称为是一个业务独立的运行单元，或者是大型业务系统的一个业务中心，或者是一个业务中心内功能较为独立的模块。比如，业务中台的商品中心一般会对上架的商品进行操作审计。营销活动的营销中心也是如此。
但是，商品中心的修改商品信息接口内的商品类调用库存类去修改商品的库存则一般不需要额外单独记录。

# 统一数据结构

## 结构化数据

审计的目标是为了说清楚发生了什么事情，包含

|属性|类型|是否必须|含义|
|---|---|---|---|
|时间|date|1|什么时间进行的操作|
|操作人|string|0|由谁进行的操作，通常是用户的id或用户名|
|使用的设备|string|0|使用的设备指纹|
|使用的应用|string|0|使用的应用程序名称或id|
|所在的网络位置|string|1|ip地址|
|所在的地理位置|json|0|国家和地区|
|被操作的目标|string|1|通常是接口地址或者方法名，比如人员接口，密码重置接口或某个方法等|
|操作动作|string|1|通常是http方法或者一个动作编码，比如POST、reset|
|操作结果|string|1|通常是http响应状态或者操作结果状态码|
|操作参数详情|json|1|操作的入参|
|操作响应详情|json|1|操作的响应|
|操作前数据快照|json|1|如果是修改，删除等操作，操作之前的数据快照是什么|
|其他上下文信息|json|0|其它扩展信息|

* 设备指纹用来在审计中表达用户使用的硬件设备是否发生变化
* 应用是访问端的应用id
* ip地址一般需要网管层传入，现在的系统一般都是远程调用，因此ip地址一般会存在
* 国家和地理位置则需要对接ip地址信息库
* 被操作的目标往往是一个接口地址或rpc的一个方法名称(不一定是类的某个方法)
* 操作动作则需要一定程度的分析，比如
    * restful的接口使用http方法来表达动作，比如"get /user"和"post /user"，操作目标都是用户，但行为不同
    * 非http服务则一般需要从参数或者方法名上进行定义了
* 操作结果，其实一般就是成功与否的标记，如果是http接口，则4xx和5xx和接口方法抛出异常一概代表失败，其它情况则需要额外分析响应结果是否符合预期

# 基本架构

```plantuml
@startuml
!include https://s3.cn-south-1.jdcloud-oss.com/c4-plantuml/C4_Container.puml

System(采集器, 采集器, Collector)
System(存储器, 存储器, Saver)
System(持久化存储, 持久化存储, Persistence)
System(持久化存储, 持久化存储, Persistence)

@enduml
```

# api接口拦截

api接口拦截通常指的是在"controller"层进行拦截，它联合"api-advice-engine"执行接口前置切面并捕获接口的请求参数和响应结果

## 接口数据向审计数据的转换

在完成接口调用的拦截后，拦截器会自动填写以下审计信息

* 时间
* 操作人(当前登录用户)
* 使用的设备(需要请求方发送设备指纹)
* 使用的手段(请求token或安全凭据中的客户端id)
* 所在的位置(ip地址和地理位置)
* 被操作目标(接口地址)
* 操作动作(http 动作)
* 操作结果(http状态码)
* 操作参数详情(http请求体)
* 操作响应详情(http响应体)
